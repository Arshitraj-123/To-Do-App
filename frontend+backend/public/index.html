<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Task Flow Dashboard</title>
    <meta name="description" content="Modern Dashboard Homepage" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #2c3e50;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .container {
        width: 100%;
        max-width: 1200px;
        background: white;
        border-radius: 24px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        display: grid;
        grid-template-columns: 1fr 1fr;
        min-height: 700px;
      }

      /* Left Panel */
      .left-panel {
        padding: 3rem;
        position: relative;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .decorative-circle {
        position: absolute;
        border-radius: 50%;
        opacity: 0.1;
      }

      .circle-blue {
        width: 150px;
        height: 150px;
        background: #3b82f6;
        top: -75px;
        left: -75px;
      }

      .circle-purple {
        width: 100px;
        height: 100px;
        background: #8b5cf6;
        top: 30px;
        right: 60px;
      }

      .circle-indigo {
        width: 120px;
        height: 120px;
        background: #6366f1;
        bottom: -60px;
        right: -60px;
      }

      .logo {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 2.5rem;
        z-index: 10;
        position: relative;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .form-group {
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 10;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #475569;
        font-weight: 600;
        font-size: 0.95rem;
      }

      .form-group input {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
        color: #1e293b;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        transform: translateY(-1px);
      }

      .password-field {
        position: relative;
      }

      .password-toggle {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #64748b;
        font-size: 1.2rem;
        transition: color 0.3s ease;
      }

      .password-toggle:hover {
        color: #667eea;
      }

      .forgot-password {
        text-align: center;
        margin: 1.5rem 0;
      }

      .forgot-password a,
      .register-link a,
      .back-to-login {
        color: #667eea;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        transition: color 0.3s ease;
        cursor: pointer;
      }

      .forgot-password a:hover,
      .register-link a:hover,
      .back-to-login:hover {
        color: #5a67d8;
      }

      .login-btn {
        width: 75%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
        position: relative;
        overflow: hidden;
      }

      .login-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .login-btn:hover::before {
        left: 100%;
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .login-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      .arrow-btn {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 1.4rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 1rem;
      }

      .arrow-btn:hover {
        transform: translateY(-2px) rotate(5deg);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
      }

      .register-link,
      .back-to-login-link {
        text-align: center;
        margin-top: 2rem;
        color: #64748b;
        font-size: 0.9rem;
      }

      /* Right Panel */
      .right-panel {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .dashboard-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 60px 40px;
        position: relative;
        overflow: hidden;
      }

      .dashboard-preview::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 50%
        );
        animation: rotate 30s linear infinite;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .preview-content {
        position: relative;
        z-index: 2;
        text-align: center;
        color: white;
      }

      .dashboard-mockup {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 40px;
        width: 100%;
        max-width: 400px;
      }

      .mockup-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .mockup-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: white;
      }

      .mockup-controls {
        display: flex;
        gap: 6px;
      }

      .control-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
      }

      .mockup-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        text-align: left;
      }

      .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
      }

      .mockup-chart {
        height: 80px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }

      .chart-bars {
        display: flex;
        align-items: end;
        height: 100%;
        padding: 12px;
        gap: 4px;
      }

      .chart-bar {
        flex: 1;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 2px;
        animation: chartGrow 2s ease-out infinite alternate;
      }

      .chart-bar:nth-child(1) {
        height: 60%;
        animation-delay: 0s;
      }
      .chart-bar:nth-child(2) {
        height: 85%;
        animation-delay: 0.2s;
      }
      .chart-bar:nth-child(3) {
        height: 45%;
        animation-delay: 0.4s;
      }
      .chart-bar:nth-child(4) {
        height: 90%;
        animation-delay: 0.6s;
      }
      .chart-bar:nth-child(5) {
        height: 70%;
        animation-delay: 0.8s;
      }
      .chart-bar:nth-child(6) {
        height: 55%;
        animation-delay: 1s;
      }

      @keyframes chartGrow {
        0% {
          opacity: 0.6;
        }
        100% {
          opacity: 1;
        }
      }

      .preview-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 16px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .preview-description {
        font-size: 1.1rem;
        opacity: 0.9;
        line-height: 1.6;
        max-width: 350px;
        margin: 0 auto;
      }

      .feature-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-top: 32px;
        max-width: 400px;
      }

      .feature-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.1);
        padding: 12px 16px;
        border-radius: 8px;
        backdrop-filter: blur(5px);
      }

      .feature-icon {
        width: 24px;
        height: 24px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .feature-text {
        font-size: 0.9rem;
        font-weight: 500;
      }

      /* Connection status indicator */
      .connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 1000;
      }

      .connection-status.connected {
        background: #10b981;
        color: white;
      }

      .connection-status.disconnected {
        background: #ef4444;
        color: white;
      }

      /* Responsive styles can go here if you want */
    </style>
  </head>

  <body>
   
    <div id="connection-status" class="connection-status disconnected">
      Server Disconnected
    </div>

    <div class="container">
      <!-- Left Panel -->
      <div class="left-panel">
        <div class="decorative-circle circle-blue"></div>
        <div class="decorative-circle circle-purple"></div>
        <div class="decorative-circle circle-indigo"></div>

        <div class="logo">Task Flow<br />Dashboard</div>

        <!-- Form container -->
        <div id="form-container">
         
          <form id="login-form" autocomplete="off">
            <div class="form-group">
              <label for="username">Email</label>
              <input
                type="email"
                id="username"
                name="username"
                placeholder="Enter your email"
                required
              />
            </div>

            <div class="form-group">
              <label for="password">Password</label>
              <div class="password-field">
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="Enter your password"
                  required
                />
                <button
                  type="button"
                  class="password-toggle"
                  onclick="togglePassword()"
                  aria-label="Toggle password visibility"
                >
                  👁
                </button>
              </div>
            </div>

            <div class="forgot-password">
              <a href="#" id="forgot-password-link">Forgot Password?</a>
            </div>

            <div style="display: flex; align-items: center; flex-wrap: wrap">
              <button type="submit" class="login-btn" id="login-btn">
                LOGIN
              </button>
              <button
                type="button"
                class="arrow-btn"
                onclick="handleArrowClick()"
                aria-label="Continue arrow button"
              >
                →
              </button>
            </div>
          </form>

          <!-- REGISTER FORM (hidden initially) -->
          <form id="register-form" style="display: none" autocomplete="off">
            <div class="form-group">
              <label for="register-username">Username</label>
              <input
                type="text"
                id="register-username"
                name="register-username"
                placeholder="Enter your username"
                required
                minlength="3"
              />
            </div>
            <div class="form-group">
              <label for="register-email">Email</label>
              <input
                type="email"
                id="register-email"
                name="register-email"
                placeholder="Enter your email"
                required
              />
            </div>
            <div class="form-group">
              <label for="register-password">Password</label>
              <input
                type="password"
                id="register-password"
                name="register-password"
                placeholder="Enter your password (min 6 chars)"
                required
                minlength="6"
              />
            </div>

            <div style="display: flex; align-items: center; flex-wrap: wrap">
              <button type="submit" class="login-btn" id="register-btn">
                REGISTER
              </button>
            </div>

            <div
              class="back-to-login-link"
              style="margin-top: 1rem; text-align: center"
            >
              <a href="#" id="back-to-login-from-register" class="back-to-login"
                >Back to Login</a
              >
            </div>
          </form>

          <!-- FORGOT PASSWORD FORM (hidden initially) -->
          <form id="forgot-password-form" style="display: none" autocomplete="off">
            <div class="form-group">
              <label for="forgot-email">Enter your registered email</label>
              <input
                type="email"
                id="forgot-email"
                name="forgot-email"
                placeholder="Email address"
                required
              />
            </div>

            <div style="display: flex; align-items: center; flex-wrap: wrap">
              <button type="submit" class="login-btn" id="forgot-btn">
                Reset Password
              </button>
            </div>

            <div
              class="back-to-login-link"
              style="margin-top: 1rem; text-align: center"
            >
              <a href="#" id="back-to-login-from-forgot" class="back-to-login"
                >Back to Login</a
              >
            </div>
          </form>
        </div>

        <!-- "Don't have an account?" line shown only on login form -->
        <div class="register-link" id="register-link">
          Don't have an account?
          <a href="#" id="show-register-form">REGISTER</a>
        </div>
      </div>

      <!-- Right Panel / dashboard preview -->
      <div class="dashboard-preview">
        <div class="preview-content">
          <div class="dashboard-mockup">
            <div class="mockup-header">
              <div class="mockup-title">Dashboard Overview</div>
              <div class="mockup-controls">
                <div class="control-dot"></div>
                <div class="control-dot"></div>
                <div class="control-dot"></div>
              </div>
            </div>

            <div class="mockup-stats">
              <div class="stat-card">
                <div class="stat-number">2,847</div>
                <div class="stat-label">Active Tasks</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">94%</div>
                <div class="stat-label">Completion Rate</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">156</div>
                <div class="stat-label">Team Members</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">12</div>
                <div class="stat-label">Active Projects</div>
              </div>
            </div>

            <div class="mockup-chart">
              <div class="chart-bars">
                <div class="chart-bar"></div>
                <div class="chart-bar"></div>
                <div class="chart-bar"></div>
                <div class="chart-bar"></div>
                <div class="chart-bar"></div>
                <div class="chart-bar"></div>
              </div>
            </div>
          </div>

          <h2 class="preview-title">Task Flow Dashboard</h2>
          <p class="preview-description">
            Streamline your workflow and boost productivity with our
            comprehensive task management platform. Built for teams and
            individuals who demand excellence.
          </p>

          <div class="feature-list">
            <div class="feature-item">
              <div class="feature-icon">📊</div>
              <div class="feature-text">Advanced Analytics</div>
            </div>
            <div class="feature-item">
              <div class="feature-icon">⚡</div>
              <div class="feature-text">Real-time Updates</div>
            </div>
            <div class="feature-item">
              <div class="feature-icon">👥</div>
              <div class="feature-text">Team Collaboration</div>
            </div>
            <div class="feature-item">
              <div class="feature-icon">🔒</div>
              <div class="feature-text">Security</div>
            </div>
          </div>
        </div>
      </div>
    </div>
<script>

const API_BASE_URL = window.location.origin; // Uses the same domain as the page

// Connection status elements
const connectionStatus = document.getElementById('connection-status');

// Password toggle for all password inputs
function togglePassword() {
  const pwdFields = document.querySelectorAll("input[type='password']");
  pwdFields.forEach((pwd) => {
    pwd.type = pwd.type === "password" ? "text" : "password";
  });
}

function handleArrowClick() {
  alert("Please log in to continue.");
}

// Elements
const loginForm = document.getElementById("login-form");
const registerForm = document.getElementById("register-form");
const forgotPasswordForm = document.getElementById("forgot-password-form");
const registerLinkDiv = document.getElementById("register-link");

const showRegisterLink = document.getElementById("show-register-form");
const forgotPasswordLink = document.getElementById("forgot-password-link");
const backToLoginFromRegister = document.getElementById("back-to-login-from-register");
const backToLoginFromForgot = document.getElementById("back-to-login-from-forgot");

// UI toggle functions
function showLoginForm() {
  loginForm.style.display = "block";
  registerForm.style.display = "none";
  forgotPasswordForm.style.display = "none";
  registerLinkDiv.style.display = "block";
}

function showRegisterForm() {
  loginForm.style.display = "none";
  registerForm.style.display = "block";
  forgotPasswordForm.style.display = "none";
  registerLinkDiv.style.display = "none";
}

function showForgotPasswordForm() {
  loginForm.style.display = "none";
  registerForm.style.display = "none";
  forgotPasswordForm.style.display = "block";
  registerLinkDiv.style.display = "none";
}

// Event listeners for toggling forms
showRegisterLink.addEventListener("click", (e) => {
  e.preventDefault();
  showRegisterForm();
});

forgotPasswordLink.addEventListener("click", (e) => {
  e.preventDefault();
  showForgotPasswordForm();
});

backToLoginFromRegister.addEventListener("click", (e) => {
  e.preventDefault();
  showLoginForm();
});

backToLoginFromForgot.addEventListener("click", (e) => {
  e.preventDefault();
  showLoginForm();
});

// Helper for safe JSON parsing
async function safeJson(response) {
  const contentType = response.headers.get("content-type") || "";
  if (contentType.includes("application/json")) {
    return response.json();
  }
  return null;
}


async function testServerConnection() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/health`);
    if (response.ok) {
      const healthData = await response.json();
      console.log("✅ Server connection successful:", healthData);
      connectionStatus.textContent = "Server Connected";
      connectionStatus.className = "connection-status connected";
      
      // Log server features for debugging
      if (healthData.features) {
        console.log("📋 Server features:", healthData.features);
      }
      
      return true;
    } else {
      console.error("❌ Server responded with error:", response.status);
      connectionStatus.textContent = `Server Error (${response.status})`;
      connectionStatus.className = "connection-status disconnected";
      return false;
    }
  } catch (error) {
    console.error("❌ Cannot connect to server:", error.message);
    connectionStatus.textContent = "Server Disconnected";
    connectionStatus.className = "connection-status disconnected";
    
    // Show helpful error message
    if (window.location.protocol === 'file:') {
      alert("⚠️ You're opening this file directly. Please:\n1. Start your server: node server.js\n2. Visit: http://localhost:8000");
    } else {
      console.warn("❌ Cannot connect to server. Please make sure the backend is running.");
      // Don't show alert on every failed connection check
    }
    return false;
  }
}

// Enhanced error message handler
function getErrorMessage(data, response) {
  if (data && data.message) {
    return data.message;
  }
  if (data && data.errors && Array.isArray(data.errors) && data.errors.length > 0) {
    return data.errors.map(err => err.msg || err.message || err).join(", ");
  }
  return response.statusText || "An unknown error occurred";
}

// Show notification function
function showNotification(message, type = 'info') {
  // Remove existing notifications
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();

  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.textContent = message;
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    z-index: 10000;
    max-width: 300px;
    word-wrap: break-word;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    color: white;
    font-weight: 500;
    animation: slideInRight 0.3s ease;
    background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
  `;

  document.body.appendChild(notif);

  setTimeout(() => {
    notif.style.animation = 'slideOutRight 0.3s ease forwards';
    setTimeout(() => notif.remove(), 300);
  }, 4000);
}

// Handle Login submission with enhanced feedback
loginForm.addEventListener("submit", async (event) => {
  event.preventDefault();
  
  // Test connection first
  if (!(await testServerConnection())) {
    showNotification("Cannot connect to server. Please try again.", 'error');
    return;
  }
  
  const emailInput = document.getElementById("username");
  const email = emailInput ? emailInput.value.trim() : "";
  const password = document.getElementById("password").value.trim();

  if (!email || !password) {
    showNotification("Please enter both email and password.", 'error');
    return;
  }

  // Basic email validation
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showNotification("Please enter a valid email address.", 'error');
    return;
  }

  const loginBtn = document.getElementById("login-btn");
  const originalText = loginBtn.textContent;
  loginBtn.disabled = true;
  loginBtn.textContent = "Logging in...";

  try {
    console.log("🔐 Attempting login for:", email);
    
    const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        email: email,
        password: password,
      }),
    });

    console.log("📡 Login response status:", response.status);
    const data = await safeJson(response);

    if (!response.ok) {
      const errorMessage = getErrorMessage(data, response);
      console.error("❌ Login failed:", errorMessage);
      showNotification(`Login failed: ${errorMessage}`, 'error');
      return;
    }

    // Validate response data
    if (!data.access_token || !data.username || !data.email) {
      console.error("❌ Invalid login response:", data);
      showNotification("Login failed: Invalid server response", 'error');
      return;
    }

    // Save token AND user data (aligning with server response)
    localStorage.setItem("token", data.access_token);
    localStorage.setItem("username", data.username);
    localStorage.setItem("email", data.email);
    
    console.log("✅ Login successful for user:", data.username);
    showNotification(`Welcome back, ${data.username}!`, 'success');
    
    // Small delay to show success message before redirect
    setTimeout(() => {
      window.location.href = "dashboard.html"; 
    }, 1000);

  } catch (error) {
    console.error("💥 Login error:", error);
    showNotification(`Network error: ${error.message}`, 'error');
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = originalText;
  }
});

// Handle Registration submission with enhanced validation
registerForm.addEventListener("submit", async (event) => {
  event.preventDefault();
  
  // Test connection first
  if (!(await testServerConnection())) {
    showNotification("Cannot connect to server. Please try again.", 'error');
    return;
  }
  
  const username = document.getElementById("register-username").value.trim();
  const email = document.getElementById("register-email").value.trim();
  const password = document.getElementById("register-password").value.trim();

  // Client-side validation (matching server.js validation rules)
  if (!username || !email || !password) {
    showNotification("Please fill all registration fields.", 'error');
    return;
  }

  if (username.length < 3) {
    showNotification("Username must be at least 3 characters long.", 'error');
    return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showNotification("Please enter a valid email address.", 'error');
    return;
  }

  if (password.length < 6) {
    showNotification("Password must be at least 6 characters long.", 'error');
    return;
  }

  const registerBtn = document.getElementById("register-btn");
  const originalText = registerBtn.textContent;
  registerBtn.disabled = true;
  registerBtn.textContent = "Registering...";

  try {
    console.log("📝 Attempting registration:", { username, email });
    
    const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ username, email, password }),
    });

    console.log("📡 Registration response status:", response.status);
    const data = await safeJson(response);

    if (!response.ok) {
      const errorMessage = getErrorMessage(data, response);
      console.error("❌ Registration failed:", errorMessage);
      showNotification(`Registration failed: ${errorMessage}`, 'error');
      return;
    }

    console.log("✅ Registration successful for:", username);
    showNotification("🎉 Registration successful! You can now log in.", 'success');
    
    registerForm.reset();

    // Switch to login form after successful registration
    setTimeout(() => {
      showLoginForm();
      // Pre-fill the email in login form
      const loginEmailField = document.getElementById("username");
      if (loginEmailField) {
        loginEmailField.value = email;
        loginEmailField.focus();
      }
    }, 1500);
    
  } catch (error) {
    console.error("💥 Registration error:", error);
    showNotification(`Network error: ${error.message}`, 'error');
  } finally {
    registerBtn.disabled = false;
    registerBtn.textContent = originalText;
  }
});

// Handle Forgot Password submission
forgotPasswordForm.addEventListener("submit", async (event) => {
  event.preventDefault();
  
  // Test connection first
  if (!(await testServerConnection())) {
    showNotification("Cannot connect to server. Please try again.", 'error');
    return;
  }
  
  const email = document.getElementById("forgot-email").value.trim();

  if (!email) {
    showNotification("Please enter your registered email.", 'error');
    return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showNotification("Please enter a valid email address.", 'error');
    return;
  }

  const forgotBtn = document.getElementById("forgot-btn");
  const originalText = forgotBtn.textContent;
  forgotBtn.disabled = true;
  forgotBtn.textContent = "Sending...";

  try {
    console.log("🔐 Attempting password reset for:", email);
    
    const response = await fetch(`${API_BASE_URL}/api/auth/forgot-password`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ email }),
    });

    const data = await safeJson(response);

    if (!response.ok) {
      const errorMessage = getErrorMessage(data, response);
      console.error("❌ Forgot password failed:", errorMessage);
      showNotification(`Failed to send reset instructions: ${errorMessage}`, 'error');
      return;
    }

    console.log("✅ Password reset request sent");
    showNotification("If the email is registered, you will receive password reset instructions.", 'success');
    
    forgotPasswordForm.reset();

    // Switch back to login form after submission
    setTimeout(() => {
      showLoginForm();
    }, 2000);
    
  } catch (error) {
    console.error("💥 Forgot password error:", error);
    showNotification(`Network error: ${error.message}`, 'error');
  } finally {
    forgotBtn.disabled = false;
    forgotBtn.textContent = originalText;
  }
});

// Check if user is already logged in
function checkExistingAuth() {
  const token = localStorage.getItem('token');
  const username = localStorage.getItem('username');
  
  if (token && username) {
    console.log("🔐 User already logged in:", username);
    // Optionally verify token with server
    verifyTokenAndRedirect();
  }
}

// Verify existing token with server
async function verifyTokenAndRedirect() {
  const token = localStorage.getItem('token');
  if (!token) return;

  try {
    const response = await fetch(`${API_BASE_URL}/api/me`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (response.ok) {
      const user = await response.json();
      console.log("✅ Token valid, redirecting to dashboard");
      showNotification(`Welcome back, ${user.username}!`, 'success');
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 1000);
    } else {
      console.log("🔐 Token invalid, clearing storage");
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('email');
    }
  } catch (error) {
    console.error("Error verifying token:", error);
  }
}

// Initialize to show login form
showLoginForm();

// Check for existing authentication on page load
window.addEventListener('load', () => {
  // Small delay to let the page fully load
  setTimeout(() => {
    testServerConnection();
    checkExistingAuth();
  }, 500);
});

// Periodic connection check (every 60 seconds - less frequent)
setInterval(() => {
  testServerConnection();
}, 60000);

// Add CSS for notifications
const style = document.createElement('style');
style.textContent = `
@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

.notification {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 14px;
  line-height: 1.4;
}

/* Enhanced connection status styling */
.connection-status {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.connection-status.connected {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.connection-status.disconnected {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

/* Enhanced form styling */
.form-group {
  position: relative;
}

.form-group input:focus {
  outline: none;
  border-color: #3498db;
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
}

.btn:disabled:hover {
  transform: none !important;
}
`;
document.head.appendChild(style);

// Add form validation visual feedback
function addValidationStyling() {
  const inputs = document.querySelectorAll('input[type="email"], input[type="text"], input[type="password"]');
  
  inputs.forEach(input => {
    input.addEventListener('blur', function() {
      this.classList.remove('valid', 'invalid');
      
      if (this.value.trim()) {
        if (this.type === 'email') {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          this.classList.add(emailRegex.test(this.value) ? 'valid' : 'invalid');
        } else {
          this.classList.add('valid');
        }
      }
    });
    
    input.addEventListener('input', function() {
      this.classList.remove('invalid');
    });
  });
}

// Initialize validation styling
document.addEventListener('DOMContentLoaded', () => {
  addValidationStyling();
});
</script>

  </body>
</html>